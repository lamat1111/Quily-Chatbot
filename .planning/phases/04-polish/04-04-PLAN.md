---
phase: 04-polish
plan: 04
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/components/ui/ApiKeyModal.tsx
  - src/components/sidebar/Sidebar.tsx
  - src/components/sidebar/ApiKeyConfig.tsx
autonomous: true

must_haves:
  truths:
    - "API key configuration opens in modal dialog (not inline in sidebar)"
    - "Modal includes OpenRouter explanation and signup link"
    - "Modal has proper focus trap and escape-to-close"
    - "Modal is accessible (ARIA labels, focus management)"
  artifacts:
    - path: "src/components/ui/ApiKeyModal.tsx"
      provides: "Radix Dialog-based API key modal"
      exports: ["ApiKeyModal"]
    - path: "src/components/sidebar/Sidebar.tsx"
      provides: "Trigger button for modal"
      contains: "ApiKeyModal"
  key_links:
    - from: "Sidebar.tsx"
      to: "ApiKeyModal"
      via: "render modal with trigger"
      pattern: "ApiKeyModal"
    - from: "ApiKeyModal"
      to: "@radix-ui/react-dialog"
      via: "import Dialog primitives"
      pattern: "import \\* as Dialog"
---

<objective>
Move API key configuration from inline sidebar to modal dialog with OpenRouter explanation.

Purpose: Satisfies POLISH-04. Modal provides better UX for configuration (focused attention, clear CTA) and includes helpful context about OpenRouter for new users.

Output: API key button in sidebar triggers modal with form, explanation, and signup link.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-polish/04-RESEARCH.md

# Files we're modifying
@src/components/sidebar/Sidebar.tsx
@src/components/sidebar/ApiKeyConfig.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ApiKeyModal component</name>
  <files>src/components/ui/ApiKeyModal.tsx</files>
  <action>
Create `src/components/ui/ApiKeyModal.tsx` using Radix UI Dialog:

```typescript
'use client';

import { useState, useCallback } from 'react';
import * as Dialog from '@radix-ui/react-dialog';
import { useLocalStorage } from '@/src/hooks/useLocalStorage';
import { validateApiKey } from '@/src/lib/openrouter';

interface ApiKeyModalProps {
  children: React.ReactNode;  // Trigger element
}

/**
 * Modal dialog for API key configuration.
 *
 * Features:
 * - OpenRouter explanation for new users
 * - Link to create account / get API key
 * - Password input with validation
 * - Accessible with proper focus trap
 */
export function ApiKeyModal({ children }: ApiKeyModalProps) {
  const [open, setOpen] = useState(false);
  const [apiKey, setApiKey, isHydrated] = useLocalStorage<string>(
    'openrouter-api-key',
    ''
  );
  const [inputValue, setInputValue] = useState('');
  const [isValidating, setIsValidating] = useState(false);
  const [validationResult, setValidationResult] = useState<'valid' | 'invalid' | null>(null);

  // Sync input with stored key when modal opens
  const handleOpenChange = (isOpen: boolean) => {
    setOpen(isOpen);
    if (isOpen && isHydrated) {
      setInputValue(apiKey);
      setValidationResult(null);
    }
  };

  const handleSave = useCallback(async () => {
    if (!inputValue.trim()) return;

    setIsValidating(true);
    setValidationResult(null);

    try {
      const isValid = await validateApiKey(inputValue);
      if (isValid) {
        setApiKey(inputValue);
        setValidationResult('valid');
        // Close modal after brief delay to show success
        setTimeout(() => setOpen(false), 500);
      } else {
        setValidationResult('invalid');
      }
    } catch {
      setValidationResult('invalid');
    } finally {
      setIsValidating(false);
    }
  }, [inputValue, setApiKey]);

  const handleClear = useCallback(() => {
    setApiKey('');
    setInputValue('');
    setValidationResult(null);
  }, [setApiKey]);

  // Display hint for existing key
  const keyHint = apiKey.length > 6 ? `Current: ••••••${apiKey.slice(-6)}` : null;

  return (
    <Dialog.Root open={open} onOpenChange={handleOpenChange}>
      <Dialog.Trigger asChild>
        {children}
      </Dialog.Trigger>
      <Dialog.Portal>
        <Dialog.Overlay className="fixed inset-0 bg-black/70 z-50 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0" />
        <Dialog.Content className="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-md bg-white dark:bg-gray-800 rounded-xl p-6 z-50 shadow-xl focus:outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95">

          <Dialog.Title className="text-lg font-semibold text-gray-900 dark:text-white">
            OpenRouter API Key
          </Dialog.Title>

          <Dialog.Description className="text-sm text-gray-600 dark:text-gray-400 mt-2">
            This app uses{' '}
            <a
              href="https://openrouter.ai"
              target="_blank"
              rel="noopener noreferrer"
              className="text-blue-600 dark:text-blue-400 hover:underline"
            >
              OpenRouter
            </a>
            {' '}to access AI models like Claude, GPT-4, and Llama. Your API key is stored locally in your browser and never sent to our servers.
          </Dialog.Description>

          {/* Form */}
          <div className="mt-4 space-y-4">
            <div>
              <label htmlFor="modal-api-key" className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                API Key
              </label>
              <input
                id="modal-api-key"
                type="password"
                value={inputValue}
                onChange={(e) => {
                  setInputValue(e.target.value);
                  setValidationResult(null);
                }}
                placeholder="sk-or-..."
                className={`w-full px-3 py-2 text-sm rounded-lg border
                  bg-gray-50 dark:bg-gray-700
                  text-gray-900 dark:text-gray-100
                  placeholder-gray-400 dark:placeholder-gray-500
                  focus:outline-none focus:ring-2 focus:ring-blue-500
                  ${validationResult === 'valid' ? 'border-green-500' : ''}
                  ${validationResult === 'invalid' ? 'border-red-500' : ''}
                  ${validationResult === null ? 'border-gray-300 dark:border-gray-600' : ''}
                `}
              />
              {keyHint && !inputValue && (
                <p className="mt-1 text-xs text-gray-500 dark:text-gray-400">{keyHint}</p>
              )}
              {validationResult === 'invalid' && (
                <p className="mt-1 text-xs text-red-600 dark:text-red-400">
                  Invalid API key. Please check and try again.
                </p>
              )}
              {validationResult === 'valid' && (
                <p className="mt-1 text-xs text-green-600 dark:text-green-400">
                  API key validated successfully!
                </p>
              )}
            </div>

            {/* Action buttons */}
            <div className="flex gap-3">
              <button
                onClick={handleSave}
                disabled={isValidating || !inputValue.trim()}
                className="flex-1 px-4 py-2 text-sm font-medium rounded-lg
                  bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400
                  text-white transition-colors
                  focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2
                  dark:focus:ring-offset-gray-800
                  disabled:cursor-not-allowed"
              >
                {isValidating ? 'Validating...' : 'Save'}
              </button>
              {apiKey && (
                <button
                  onClick={handleClear}
                  className="px-4 py-2 text-sm font-medium rounded-lg
                    bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600
                    text-gray-700 dark:text-gray-300 transition-colors
                    focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2
                    dark:focus:ring-offset-gray-800"
                >
                  Clear
                </button>
              )}
            </div>
          </div>

          {/* Get API key link */}
          <div className="mt-4 pt-4 border-t border-gray-200 dark:border-gray-700">
            <p className="text-sm text-gray-600 dark:text-gray-400">
              Don&apos;t have an API key?{' '}
              <a
                href="https://openrouter.ai/settings/keys"
                target="_blank"
                rel="noopener noreferrer"
                className="text-blue-600 dark:text-blue-400 hover:underline font-medium"
              >
                Create one at OpenRouter
              </a>
            </p>
          </div>

          {/* Close button */}
          <Dialog.Close asChild>
            <button
              className="absolute top-4 right-4 p-1 rounded hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"
              aria-label="Close"
            >
              <svg className="w-5 h-5 text-gray-500 dark:text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>
          </Dialog.Close>
        </Dialog.Content>
      </Dialog.Portal>
    </Dialog.Root>
  );
}
```

Key features:
- Radix Dialog for accessibility (focus trap, escape key, screen reader)
- OpenRouter explanation for new users
- Link to signup/get API key
- Password input (always masked per security decision)
- Save validates before storing
- Clear button to remove key
- Theme-aware styling throughout
- Subtle animations on open/close
  </action>
  <verify>
- File exists at src/components/ui/ApiKeyModal.tsx
- `npx tsc --noEmit` passes
  </verify>
  <done>ApiKeyModal component created with Radix Dialog and OpenRouter info</done>
</task>

<task type="auto">
  <name>Task 2: Update Sidebar to use ApiKeyModal</name>
  <files>src/components/sidebar/Sidebar.tsx</files>
  <action>
Update `src/components/sidebar/Sidebar.tsx`:

1. Import ApiKeyModal:
   ```typescript
   import { ApiKeyModal } from '@/src/components/ui/ApiKeyModal';
   ```

2. Replace inline ApiKeyConfig with modal trigger button. The button should:
   - Show API key status (configured vs not configured)
   - Use colored indicator: green circle if key exists, red if not
   - Wrap in ApiKeyModal as trigger

3. Replace ApiKeyConfig section with:
   ```typescript
   {/* API Key Configuration */}
   <ApiKeyModal>
     <button className="w-full flex items-center gap-3 px-3 py-2 text-sm rounded-lg
       text-gray-700 dark:text-gray-300
       hover:bg-gray-100 dark:hover:bg-gray-700
       transition-colors text-left">
       {/* Status indicator */}
       <span className={`w-2 h-2 rounded-full ${apiKey ? 'bg-green-500' : 'bg-red-500'}`} />
       <span className="flex-1">
         {apiKey ? 'API Key Configured' : 'Configure API Key'}
       </span>
       {/* Settings icon */}
       <svg className="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
         <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
         <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
       </svg>
     </button>
   </ApiKeyModal>
   ```

4. You'll need to access apiKey state in Sidebar. Use the useLocalStorage hook:
   ```typescript
   const [apiKey] = useLocalStorage<string>('openrouter-api-key', '');
   ```

5. Make all Sidebar colors theme-aware if not already:
   - bg-gray-900 -> bg-white dark:bg-gray-900
   - text-gray-100 -> text-gray-900 dark:text-gray-100
   - border-gray-700 -> border-gray-200 dark:border-gray-700
   - Hover states similarly

6. Keep ApiKeyConfig.tsx file for now (may be useful as reference), but it's no longer rendered in Sidebar.
  </action>
  <verify>
- `npx tsc --noEmit` passes
- Sidebar shows API key button with status indicator
- Clicking button opens modal
- Modal can be closed with X button or Escape key
- Modal shows OpenRouter info and signup link
  </verify>
  <done>Sidebar updated to use ApiKeyModal instead of inline config</done>
</task>

</tasks>

<verification>
After all tasks:
1. `npm run dev` - start dev server
2. Visit http://localhost:3000
3. Sidebar shows "Configure API Key" with red indicator (if no key)
4. Click button - modal opens
5. Modal shows OpenRouter explanation
6. Modal has link to openrouter.ai/settings/keys
7. Enter valid API key - shows success, modal closes
8. Sidebar now shows "API Key Configured" with green indicator
9. Click again - modal opens with current key hint
10. Press Escape - modal closes
11. Test in light mode - all colors correct
</verification>

<success_criteria>
- POLISH-04 satisfied: API key config in modal with OpenRouter explanation
- Modal is accessible (focus trap, escape to close)
- Modal includes explanation and signup link
- Status indicator in sidebar shows key state
- Theme-aware colors throughout
</success_criteria>

<output>
After completion, create `.planning/phases/04-polish/04-04-SUMMARY.md`
</output>
