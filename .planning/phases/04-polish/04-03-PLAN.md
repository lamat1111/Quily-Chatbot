---
phase: 04-polish
plan: 03
type: execute
wave: 2
depends_on: ["04-02"]
files_modified:
  - src/components/chat/MarkdownRenderer.tsx
  - src/components/chat/MessageBubble.tsx
autonomous: true

must_haves:
  truths:
    - "User can copy code snippets with one click (copy button on code blocks)"
    - "User can copy entire assistant response with one click"
    - "Copy button appears on hover for code blocks"
    - "Copy button always visible for message copy"
  artifacts:
    - path: "src/components/chat/MarkdownRenderer.tsx"
      provides: "CodeBlock component with copy button"
      contains: "CopyButton"
    - path: "src/components/chat/MessageBubble.tsx"
      provides: "Message copy functionality"
      contains: "CopyButton"
  key_links:
    - from: "MarkdownRenderer.tsx"
      to: "CopyButton"
      via: "import and render in code blocks"
      pattern: "import.*CopyButton"
    - from: "MessageBubble.tsx"
      to: "CopyButton"
      via: "import and render for message copy"
      pattern: "import.*CopyButton"
---

<objective>
Add copy functionality to code blocks and message bubbles.

Purpose: Satisfies RENDER-04 (copy code snippets) and POLISH-01 (copy entire response). Users can easily share code examples and full responses.

Output: Code blocks have hover-reveal copy buttons; assistant messages have visible copy button in header.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-polish/04-RESEARCH.md

# Files we're modifying
@src/components/chat/MarkdownRenderer.tsx
@src/components/chat/MessageBubble.tsx

# Components we'll use
@src/components/ui/CopyButton.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add copy button to code blocks in MarkdownRenderer</name>
  <files>src/components/chat/MarkdownRenderer.tsx</files>
  <action>
Update `src/components/chat/MarkdownRenderer.tsx` to add copy functionality to code blocks:

1. Import CopyButton:
   ```typescript
   import { CopyButton } from '@/src/components/ui/CopyButton';
   ```

2. Extract the code block rendering into a separate CodeBlock component within the file (or inline). The key changes:

   - Wrap SyntaxHighlighter in a `div` with `relative group` classes (group enables hover reveal)
   - Add CopyButton positioned absolutely at top-right
   - Use variant="ghost" so button appears on hover
   - Pass the code content as text prop to CopyButton

3. Updated code component structure:
   ```typescript
   code({ className, children, ...props }) {
     const match = /language-(\w+)/.exec(className || '');
     const language = match ? match[1] : null;
     const isBlock = language !== null;
     const codeString = String(children).replace(/\n$/, '');

     if (isBlock) {
       return (
         <div className="relative group my-4">
           <CopyButton
             text={codeString}
             size="sm"
             variant="ghost"
             className="absolute right-2 top-2 z-10"
           />
           <SyntaxHighlighter
             style={oneDark}
             language={language}
             PreTag="div"
             className="rounded-md !bg-gray-800 dark:!bg-gray-800"
           >
             {codeString}
           </SyntaxHighlighter>
         </div>
       );
     }

     // Inline code unchanged
     return (
       <code
         className="bg-gray-200 dark:bg-gray-700 px-1.5 py-0.5 rounded text-sm font-mono"
         {...props}
       >
         {children}
       </code>
     );
   }
   ```

4. Update inline code to be theme-aware (bg-gray-200 for light, dark:bg-gray-700 for dark)

Key implementation notes:
- `group` class on parent enables `group-hover:opacity-100` in CopyButton's ghost variant
- z-10 ensures button is above syntax highlighter
- Use !bg-gray-800 to override syntax highlighter's default background
- Pre-compute codeString to avoid String() call in CopyButton prop
  </action>
  <verify>
- `npx tsc --noEmit` passes
- Code blocks in markdown render with copy button visible on hover
  </verify>
  <done>Code blocks have copy button that appears on hover</done>
</task>

<task type="auto">
  <name>Task 2: Add copy button to assistant messages</name>
  <files>src/components/chat/MessageBubble.tsx</files>
  <action>
Update `src/components/chat/MessageBubble.tsx` to add copy functionality to assistant messages:

1. Import CopyButton:
   ```typescript
   import { CopyButton } from '@/src/components/ui/CopyButton';
   ```

2. Add copy button to assistant message bubble. Position it in a header row above the content:

   ```typescript
   // Assistant message
   return (
     <div className="flex justify-start mb-4">
       <div className="max-w-[80%] bg-gray-100 dark:bg-gray-800 text-gray-900 dark:text-gray-100 rounded-2xl rounded-bl-sm px-4 py-3">
         {/* Header with copy button */}
         <div className="flex justify-between items-center mb-2 pb-2 border-b border-gray-200 dark:border-gray-700">
           <span className="text-xs text-gray-500 dark:text-gray-400 font-medium">Assistant</span>
           <CopyButton
             text={textContent}
             size="sm"
             variant="default"
             className="opacity-70 hover:opacity-100"
           />
         </div>

         <MarkdownRenderer content={textContent} />

         {/* Sources unchanged */}
         {!isStreaming && sources.length > 0 && (
           <SourcesCitation sources={sources} />
         )}
       </div>
     </div>
   );
   ```

3. Make message bubble colors theme-aware:
   - Background: bg-gray-100 dark:bg-gray-800
   - Text: text-gray-900 dark:text-gray-100
   - Border: border-gray-200 dark:border-gray-700

4. User message bubble should also be theme-aware but keep the blue accent:
   - User messages stay blue (brand color, works in both themes)
   - Keep: bg-blue-600 text-white

5. Only show copy button for assistant messages with content (not during streaming with empty content):
   - Wrap copy button in conditional: `{textContent && ...}`
   - Or position in header that's always visible

Key design decisions:
- Copy button visible (not hover) for messages - users expect to find it
- Small size (sm) to not distract from content
- Subtle opacity (70% -> 100% on hover) for polish
- Header row provides clear visual structure
  </action>
  <verify>
- `npx tsc --noEmit` passes
- Assistant messages show copy button in header
- Clicking copy button copies full message text
- Visual feedback (checkmark) appears after copy
  </verify>
  <done>Assistant messages have copy button to copy entire response</done>
</task>

</tasks>

<verification>
After all tasks:
1. `npm run dev` - start dev server
2. Send a message that generates response with code block
3. Hover over code block - copy button appears
4. Click code copy button - checkmark appears, code copied
5. Assistant message has visible copy button in header
6. Click message copy button - checkmark appears, full text copied
7. Paste in text editor - content is correctly copied
</verification>

<success_criteria>
- RENDER-04 satisfied: Code blocks have copy buttons (hover reveal)
- POLISH-01 satisfied: Assistant messages have copy button (always visible)
- Copy buttons show 2-second checkmark feedback
- Theme-aware colors throughout
</success_criteria>

<output>
After completion, create `.planning/phases/04-polish/04-03-SUMMARY.md`
</output>
